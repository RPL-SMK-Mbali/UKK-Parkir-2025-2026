## 1. Buat Middleware

```bash
php artisan make:middleware RoleMiddleware
```

## 2. Implementasi Middleware

File: `app/Http/Middleware/RoleMiddleware.php`

```php
<?php

namespace App\Http\Middleware;

use Closure;
use Illuminate\Http\Request;
use Symfony\Component\HttpFoundation\Response;
use Illuminate\Support\Facades\Auth;

class RoleMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Closure(\Illuminate\Http\Request): (\Symfony\Component\HttpFoundation\Response)  $next
     */
    public function handle(Request $request, Closure $next, ...$roles): Response
    {
        // Cek apakah user sudah login
        if (!Auth::check()) {
            return redirect()->route('login')->with('error', 'Silakan login terlebih dahulu.');
        }

        $user = Auth::user();

        // Jika tidak ada role yang ditentukan, izinkan akses
        if (empty($roles)) {
            return $next($request);
        }

        // Cek apakah user memiliki salah satu role yang diizinkan
        foreach ($roles as $role) {
            if ($user->role === $role) {
                return $next($request);
            }
        }

        // Jika tidak memiliki akses
        abort(403, 'Anda tidak memiliki akses untuk halaman ini.');
    }
}
```

## 3. Register Middleware di bootstrap/app.php

File: `bootstrap/app.php`

```php
<?php

use Illuminate\Foundation\Application;
use Illuminate\Foundation\Configuration\Exceptions;
use Illuminate\Foundation\Configuration\Middleware;
use App\Http\Middleware\RoleMiddleware;

return Application::configure(basePath: dirname(__DIR__))
    ->withRouting(
        web: __DIR__.'/../routes/web.php',
        commands: __DIR__.'/../routes/console.php',
        health: '/up',
    )
    ->withMiddleware(function (Middleware $middleware) {
        // Register custom middleware
        $middleware->alias([
            'role' => RoleMiddleware::class,
            'admin' => RoleMiddleware::class.':admin',
            'owner' => RoleMiddleware::class.':owner',
            'petugas' => RoleMiddleware::class.':petugas',
            'admin.owner' => RoleMiddleware::class.':admin,owner',
            'petugas.admin' => RoleMiddleware::class.':petugas,admin',
            'all.roles' => RoleMiddleware::class.':petugas,admin,owner',
        ]);
    })
    ->withExceptions(function (Exceptions $exceptions) {
        //
    })->create();
```

## 4. Migration untuk Role (jika belum ada)

```bash
php artisan make:migration add_role_to_users_table
```

File: `database/migrations/xxxx_xx_xx_add_role_to_users_table.php`

```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->enum('role', ['petugas', 'admin', 'owner'])
                  ->default('petugas')
                  ->after('email')
                  ->comment('petugas = staff biasa, admin = administrator, owner = pemilik');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::table('users', function (Blueprint $table) {
            $table->dropColumn('role');
        });
    }
};
```

## 5. Update Model User

File: `app/Models/User.php`

```php
<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    /**
     * The attributes that are mass assignable.
     *
     * @var array<int, string>
     */
    protected $fillable = [
        'name',
        'email',
        'password',
        'role',
    ];

    /**
     * The attributes that should be hidden for serialization.
     *
     * @var array<int, string>
     */
    protected $hidden = [
        'password',
        'remember_token',
    ];

    /**
     * Get the attributes that should be cast.
     *
     * @return array<string, string>
     */
    protected function casts(): array
    {
        return [
            'email_verified_at' => 'datetime',
            'password' => 'hashed',
        ];
    }

    /**
     * Check if user is owner
     */
    public function isOwner(): bool
    {
        return $this->role === 'owner';
    }

    /**
     * Check if user is admin
     */
    public function isAdmin(): bool
    {
        return $this->role === 'admin';
    }

    /**
     * Check if user is petugas
     */
    public function isPetugas(): bool
    {
        return $this->role === 'petugas';
    }

    /**
     * Check if user has specific role
     */
    public function hasRole(string $role): bool
    {
        return $this->role === $role;
    }

    /**
     * Check if user has any of the given roles
     */
    public function hasAnyRole(array $roles): bool
    {
        return in_array($this->role, $roles);
    }
}
```

## 6. Contoh Implementasi di Controller

File: `app/Http/Controllers/UserController.php`

```php
<?php

namespace App\Http\Controllers;

use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules;

class UserController extends Controller
{
    /**
     * Constructor
     */
    public function __construct()
    {
        // Menu user hanya bisa diakses oleh owner dan admin
        $this->middleware('role:owner,admin')->only([
            'index',
            'create',
            'store',
            'edit',
            'update',
            'destroy'
        ]);
        
        // Atau menggunakan alias yang sudah didaftarkan
        // $this->middleware('admin.owner')->only(['index', 'create', 'store']);
    }

    /**
     * Display a listing of the users.
     */
    public function index()
    {
        $users = User::paginate(10);
        return inertia('Users/Index', [
            'users' => $users,
        ]);
    }

    /**
     * Show the form for creating a new user.
     */
    public function create()
    {
        return inertia('Users/Create');
    }

    /**
     * Store a newly created user in storage.
     */
    public function store(Request $request)
    {
        $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users',
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
            'role' => 'required|in:petugas,admin,owner',
        ]);

        // Cegah petugas membuat admin/owner
        if (auth()->user()->isPetugas()) {
            abort(403, 'Petugas tidak dapat membuat user dengan role admin atau owner.');
        }

        // Cegah admin membuat owner
        if (auth()->user()->isAdmin() && $request->role === 'owner') {
            abort(403, 'Admin tidak dapat membuat user dengan role owner.');
        }

        User::create([
            'name' => $request->name,
            'email' => $request->email,
            'password' => Hash::make($request->password),
            'role' => $request->role,
        ]);

        return redirect()->route('users.index')
            ->with('success', 'User berhasil ditambahkan.');
    }

    /**
     * Show the form for editing the specified user.
     */
    public function edit(User $user)
    {
        // Owner tidak bisa diedit oleh siapapun kecuali owner lain
        if ($user->isOwner() && !auth()->user()->isOwner()) {
            abort(403, 'Hanya owner yang dapat mengedit owner lain.');
        }

        // Admin tidak bisa diedit oleh petugas
        if ($user->isAdmin() && auth()->user()->isPetugas()) {
            abort(403, 'Petugas tidak dapat mengedit admin.');
        }

        return inertia('Users/Edit', [
            'user' => $user,
        ]);
    }

    /**
     * Update the specified user in storage.
     */
    public function update(Request $request, User $user)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|string|email|max:255|unique:users,email,' . $user->id,
            'role' => 'required|in:petugas,admin,owner',
        ]);

        // Proteksi role editing
        if ($user->isOwner() && !auth()->user()->isOwner()) {
            abort(403, 'Hanya owner yang dapat mengedit owner lain.');
        }

        if ($user->isAdmin() && auth()->user()->isPetugas()) {
            abort(403, 'Petugas tidak dapat mengedit admin.');
        }

        // Cegah demosi owner
        if ($user->isOwner() && $request->role !== 'owner' && !auth()->user()->isOwner()) {
            abort(403, 'Tidak dapat mengubah role owner.');
        }

        $user->update($validated);

        return redirect()->route('users.index')
            ->with('success', 'User berhasil diupdate.');
    }

    /**
     * Remove the specified user from storage.
     */
    public function destroy(User $user)
    {
        // Owner tidak bisa dihapus kecuali oleh owner
        if ($user->isOwner() && !auth()->user()->isOwner()) {
            abort(403, 'Hanya owner yang dapat menghapus owner.');
        }

        // Admin tidak bisa dihapus oleh petugas
        if ($user->isAdmin() && auth()->user()->isPetugas()) {
            abort(403, 'Petugas tidak dapat menghapus admin.');
        }

        // Owner tidak bisa menghapus diri sendiri
        if ($user->isOwner() && $user->id === auth()->id()) {
            abort(403, 'Owner tidak dapat menghapus diri sendiri.');
        }

        $user->delete();

        return redirect()->route('users.index')
            ->with('success', 'User berhasil dihapus.');
    }
}
```

## 7. Contoh Route dengan Middleware

File: `routes/web.php`

```php
<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\UserController;
use App\Http\Controllers\DashboardController;

Route::get('/', function () {
    return inertia('Welcome');
});

// Routes yang memerlukan auth
Route::middleware(['auth', 'verified'])->group(function () {
    
    // Dashboard - bisa diakses semua role
    Route::get('/dashboard', [DashboardController::class, 'index'])
        ->name('dashboard');

    // User management - hanya owner dan admin
    Route::resource('users', UserController::class)
        ->middleware('role:owner,admin');

    // Atau dengan alias
    // Route::resource('users', UserController::class)->middleware('admin.owner');

    // Laporan - bisa diakses petugas dan admin
    Route::get('/reports', [ReportController::class, 'index'])
        ->middleware('role:petugas,admin')
        ->name('reports.index');

    // Settings - hanya owner
    Route::get('/settings', [SettingController::class, 'index'])
        ->middleware('role:owner')
        ->name('settings.index');

    // Backup - hanya owner dan admin
    Route::get('/backup', [BackupController::class, 'index'])
        ->middleware('role:owner,admin')
        ->name('backup.index');
});
```

## 8. Contoh View dengan Conditional Rendering

File: `resources/js/Pages/Layouts/AppLayout.vue`

```vue
<script setup>
import { ref } from 'vue'
import { Head, Link } from '@inertiajs/vue3'

const props = defineProps({
    user: Object
})

// Helper function untuk cek role
const hasRole = (roles) => {
    if (!props.user) return false
    return Array.isArray(roles) 
        ? roles.includes(props.user.role) 
        : props.user.role === roles
}
</script>

<template>
    <nav>
        <ul>
            <!-- Menu Dashboard - semua role -->
            <li>
                <Link :href="route('dashboard')">Dashboard</Link>
            </li>

            <!-- Menu User - hanya owner dan admin -->
            <li v-if="hasRole(['owner', 'admin'])">
                <Link :href="route('users.index')">Manajemen User</Link>
            </li>

            <!-- Menu Laporan - petugas dan admin -->
            <li v-if="hasRole(['petugas', 'admin'])">
                <Link :href="route('reports.index')">Laporan</Link>
            </li>

            <!-- Menu Settings - hanya owner -->
            <li v-if="hasRole('owner')">
                <Link :href="route('settings.index')">Pengaturan</Link>
            </li>

            <!-- Menu Backup - owner dan admin -->
            <li v-if="hasRole(['owner', 'admin'])">
                <Link :href="route('backup.index')">Backup</Link>
            </li>
        </ul>
    </nav>
</template>
```

## 9. Seeder untuk User dengan Role

File: `database/seeders/DatabaseSeeder.php`

```php
<?php

namespace Database\Seeders;

use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\Hash;

class DatabaseSeeder extends Seeder
{
    /**
     * Seed the application's database.
     */
    public function run(): void
    {
        // Owner
        User::create([
            'name' => 'Owner',
            'email' => 'owner@smkmbali.sch.id',
            'password' => Hash::make('password'),
            'role' => 'owner',
        ]);

        // Admin
        User::create([
            'name' => 'Administrator',
            'email' => 'admin@smkmbali.sch.id',
            'password' => Hash::make('password'),
            'role' => 'admin',
        ]);

        // Petugas
        User::create([
            'name' => 'Petugas 1',
            'email' => 'petugas1@smkmbali.sch.id',
            'password' => Hash::make('password'),
            'role' => 'petugas',
        ]);

        User::create([
            'name' => 'Petugas 2',
            'email' => 'petugas2@smkmbali.sch.id',
            'password' => Hash::make('password'),
            'role' => 'petugas',
        ]);
    }
}
```

## 10. Helper Function Global (Opsional)

File: `app/Helpers/helpers.php`

```php
<?php

if (!function_exists('user')) {
    /**
     * Get the authenticated user
     */
    function user()
    {
        return auth()->user();
    }
}

if (!function_exists('isOwner')) {
    /**
     * Check if authenticated user is owner
     */
    function isOwner()
    {
        return auth()->check() && auth()->user()->isOwner();
    }
}

if (!function_exists('isAdmin')) {
    /**
     * Check if authenticated user is admin
     */
    function isAdmin()
    {
        return auth()->check() && auth()->user()->isAdmin();
    }
}

if (!function_exists('isPetugas')) {
    /**
     * Check if authenticated user is petugas
     */
    function isPetugas()
    {
        return auth()->check() && auth()->user()->isPetugas();
    }
}

if (!function_exists('hasRole')) {
    /**
     * Check if authenticated user has specific role(s)
     */
    function hasRole($roles)
    {
        if (!auth()->check()) {
            return false;
        }

        $roles = is_array($roles) ? $roles : func_get_args();
        
        return auth()->user()->hasAnyRole($roles);
    }
}
```

Jangan lupa register helper di `composer.json`:

```json
"autoload": {
    "files": [
        "app/Helpers/helpers.php"
    ]
}
```

Kemudian jalankan:
```bash
composer dump-autoload
```

## Ringkasan Penggunaan Middleware

| Kode | Deskripsi |
|------|-----------|
| `->middleware('role:owner')` | Hanya owner |
| `->middleware('role:admin')` | Hanya admin |
| `->middleware('role:petugas')` | Hanya petugas |
| `->middleware('role:owner,admin')` | Owner atau admin |
| `->middleware('role:petugas,admin')` | Petugas atau admin |
| `->middleware('role:petugas,admin,owner')` | Semua role |
| `->middleware('admin.owner')` | Alias untuk owner,admin |